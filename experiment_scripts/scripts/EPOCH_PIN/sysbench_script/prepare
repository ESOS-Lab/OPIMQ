#!/bin/bash
main() {
  is_table=0
  table_size=5444444
  table_num=100
  #table_num=10000
  run_time=120
  nthreads=1
  db_name="sys_db"
  db_password="root"
  reset_tables
  do_prepare
  mysql_connect
#  do_run

}
do_run () {
  /home/sysbench/src/lua/oltp_insert.lua --mysql-host=sys_db --mysql-user=root --mysql-password=oslab1234 --mysql-db=sysbench_test --time=120 --threads=1 run
  #/home/sysbench/src/lua/oltp_write_only.lua --mysql-host=sys_db --mysql-user=root --mysql-password=oslab1234 --mysql-db=sysbench_test --table_size=${table_size} --tables=${table_num} --time=${run_time} --threads=${nthreads} run
  #/home/sysbench/src/lua/oltp_read_only.lua --mysql-host=sys_db --mysql-user=root --mysql-password=oslab1234 --mysql-db=sysbench_test --table_size=${table_size} --tables=${table_num} --time=${run_time} --threads=${nthreads} run


}
do_prepare () {

  #sysbench oltp_insert --table_size=${table_size} --tables=${table_num} --threads=40 --mysql-host=sys_db --mysql-user=root --mysql-password=oslab0810 --mysql-db=sysbench_test prepare
  sysbench oltp_insert --table_size=0 --tables=${table_num} --threads=40 --mysql-host=sys_db --mysql-user=root --mysql-password=${db_password} --mysql-db=${db_name} prepare

}
mysql_connect () {

#	mysql -h sys_db -u root -poslab1234 sysbench_test -e "SHOW TABLES" | awk '/sbtest/{print}'
	echo "Change number of db connections"
	mysql -h sys_db -u root -p${db_password} ${db_name} -e "set global max_connections = 2000;"

}
reset_tables () {
	is_table=$(mysql -h sys_db -u root -p${db_password} ${db_name} -e "SHOW TABLES" | awk '/sbtest/{print}')
	for tables in ${is_table};do
		echo "Drop Table ${tables}"
	        mysql -h sys_db -u root -p${db_password} ${db_name} -e "DROP TABLE ${tables}"
	done
}
main
